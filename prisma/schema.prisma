generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int              @id @default(autoincrement())
  fullName          String           @map("full_name")
  email             String           @unique
  passwordHash      String           @map("password_hash")
  role              String           @default("member")
  isEmailVerified   Boolean          @default(false) @map("is_email_verified")
  emailVerifyToken  String?          @unique @map("email_verify_token")
  emailVerifyExpiry DateTime?        @map("email_verify_expiry")
  inviteToken       String?          @unique @map("invite_token")
  inviteExpiry      DateTime?        @map("invite_expiry")
  invitedBy         Int?             @map("invited_by")
  createdAt         DateTime         @default(now()) @map("created_at")
  activityLogs      ActivityLog[]
  errorLogs         ErrorLog[]       @relation("ErrorReporter")
  uploadedModels    Model[]          @relation("ModelUploader")
  progressLogs      ProgressLog[]    @relation("ProgressUpdater")
  projectUsers      ProjectUser[]
  createdProjects   Project[]        @relation("ProjectCreator")
  teamLeadProjects  Project[]        @relation("TeamLeadProjects")
  roleRequests      RoleRequest[]
  taskComments      TaskComment[]
  assignedTasks     Task[]
  teamMemberships   TeamMembership[]

  @@map("users")
}

model Project {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?
  startDate    DateTime?     @map("start_date")
  endDate      DateTime?     @map("end_date")
  createdById  Int?          @map("created_by")
  createdAt    DateTime      @default(now()) @map("created_at")
  teamId       Int?          @map("team_id")
  teamLeaderId Int?          @map("team_leader_id")
  speckleUrl   String?       @map("speckle_url")
  activityLogs ActivityLog[]
  errorLogs    ErrorLog[]
  models       Model[]
  projectUsers ProjectUser[]
  createdBy    User?         @relation("ProjectCreator", fields: [createdById], references: [id])
  team         Team?         @relation(fields: [teamId], references: [id])
  teamLeader   User?         @relation("TeamLeadProjects", fields: [teamLeaderId], references: [id])
  tasks        Task[]

  @@map("projects")
}

model ProjectUser {
  id        Int     @id @default(autoincrement())
  userId    Int     @map("user_id")
  projectId Int     @map("project_id")
  role      String  @default("member")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("project_users")
}

model Model {
  id         Int       @id @default(autoincrement())
  projectId  Int       @map("project_id")
  name       String?
  source     String    @default("speckle")
  sourceUrl  String?   @map("source_url")
  sourceId   String?   @map("source_id")
  filePath   String?   @map("file_path")
  fileSize   Int?      @map("file_size")
  format     String?
  version    Int       @default(1)
  metadata   Json?
  uploadedBy Int?      @map("uploaded_by")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  elements   Element[]
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User?     @relation("ModelUploader", fields: [uploadedBy], references: [id])

  @@map("models")
}

model Element {
  id            Int               @id @default(autoincrement())
  modelId       Int               @map("model_id")
  guid          String?           @unique
  category      String?
  family        String?
  typeName      String?           @map("type_name")
  level         String?
  geometryRef   String?           @map("geometry_ref")
  parameters    Json?
  createdAt     DateTime          @default(now()) @map("created_at")
  properties    ElementProperty[]
  elementStatus ElementStatus[]
  taskLinks     ElementTaskLink[]
  model         Model             @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@map("elements")
}

model ElementProperty {
  id        Int     @id @default(autoincrement())
  elementId Int     @map("element_id")
  key       String
  value     String
  element   Element @relation(fields: [elementId], references: [id], onDelete: Cascade)

  @@map("element_properties")
}

model Task {
  id              Int               @id @default(autoincrement())
  projectId       Int               @map("project_id")
  parentId        Int?              @map("parent_id")
  name            String
  description     String?
  startDate       DateTime?         @map("start_date")
  endDate         DateTime?         @map("end_date")
  actualStartDate DateTime?         @map("actual_start_date")
  actualEndDate   DateTime?         @map("actual_end_date")
  durationDays    Int?              @map("duration_days")
  progress        Float             @default(0.0)
  color           String?
  resource        String?
  createdAt       DateTime          @default(now()) @map("created_at")
  teamId          Int?              @map("team_id")
  assigneeId      Int?              @map("assignee_id")
  status          String            @default("todo")
  priority        String?
  predecessors    Dependency[]      @relation("PredecessorTask")
  successors      Dependency[]      @relation("SuccessorTask")
  elementStatus   ElementStatus[]
  elementLinks    ElementTaskLink[]
  progressLogs    ProgressLog[]
  comments        TaskComment[]
  assignee        User?             @relation(fields: [assigneeId], references: [id])
  parent          Task?             @relation("TaskHierarchy", fields: [parentId], references: [id])
  children        Task[]            @relation("TaskHierarchy")
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team            Team?             @relation(fields: [teamId], references: [id])

  @@map("tasks")
}

model TaskComment {
  id          Int      @id @default(autoincrement())
  taskId      Int      @map("task_id")
  userId      Int      @map("user_id")
  comment     String
  attachments String?
  createdAt   DateTime @default(now()) @map("created_at")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

model Dependency {
  id            Int    @id @default(autoincrement())
  predecessorId Int    @map("predecessor_id")
  successorId   Int    @map("successor_id")
  type          String @default("FS")
  predecessor   Task   @relation("PredecessorTask", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor     Task   @relation("SuccessorTask", fields: [successorId], references: [id], onDelete: Cascade)

  @@map("dependencies")
}

model ElementTaskLink {
  id        Int       @id @default(autoincrement())
  elementId Int       @map("element_id")
  taskId    Int       @map("task_id")
  linkType  String    @default("construction") @map("link_type")
  status    String    @default("planned")
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")
  element   Element   @relation(fields: [elementId], references: [id], onDelete: Cascade)
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("element_task_links")
}

model ProgressLog {
  id              Int      @id @default(autoincrement())
  taskId          Int      @map("task_id")
  reportDate      DateTime @map("report_date")
  percentComplete Float?   @map("percent_complete")
  updatedBy       Int?     @map("updated_by")
  note            String?
  createdAt       DateTime @default(now()) @map("created_at")
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  updater         User?    @relation("ProgressUpdater", fields: [updatedBy], references: [id])

  @@map("progress_logs")
}

model ElementStatus {
  id           Int       @id @default(autoincrement())
  elementId    Int       @map("element_id")
  taskId       Int?      @map("task_id")
  actualStart  DateTime? @map("actual_start")
  actualFinish DateTime? @map("actual_finish")
  progress     Float     @default(0.0)
  lastUpdated  DateTime  @default(now()) @map("last_updated")
  element      Element   @relation(fields: [elementId], references: [id], onDelete: Cascade)
  task         Task?     @relation(fields: [taskId], references: [id])

  @@map("element_status")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  projectId Int      @map("project_id")
  action    String
  details   Json?
  timestamp DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model ErrorLog {
  id         Int      @id @default(autoincrement())
  timestamp  DateTime @default(now())
  level      String   @default("error")
  message    String
  stackTrace String?  @map("stack_trace")
  context    Json?
  userId     Int?     @map("user_id")
  projectId  Int?     @map("project_id")
  project    Project? @relation(fields: [projectId], references: [id])
  user       User?    @relation("ErrorReporter", fields: [userId], references: [id])

  @@map("error_logs")
}

model Team {
  id           Int              @id @default(autoincrement())
  name         String           @unique
  code         String?          @unique
  createdAt    DateTime         @default(now()) @map("created_at")
  projects     Project[]
  roleRequests RoleRequest[]
  tasks        Task[]
  members      TeamMembership[]

  @@map("teams")
}

model TeamMembership {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  teamId    Int      @map("team_id")
  projectId Int?     @map("project_id")
  role      String   @default("member")
  seniority String?
  createdAt DateTime @default(now()) @map("created_at")
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_memberships")
}

model RoleRequest {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  role      String
  teamId    Int?      @map("team_id")
  status    String    @default("pending")
  createdAt DateTime  @default(now()) @map("created_at")
  decidedAt DateTime? @map("decided_at")
  team      Team?     @relation(fields: [teamId], references: [id])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("role_requests")
}

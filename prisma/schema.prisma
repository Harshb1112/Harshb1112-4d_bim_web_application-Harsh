generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   Int                @id @default(autoincrement())
  fullName             String             @map("full_name")
  email                String             @unique
  passwordHash         String             @map("password_hash")
  role                 String             @default("member")
  isEmailVerified      Boolean            @default(false) @map("is_email_verified")
  emailVerifyToken     String?            @unique @map("email_verify_token")
  emailVerifyExpiry    DateTime?          @map("email_verify_expiry")
  inviteToken          String?            @unique @map("invite_token")
  inviteExpiry         DateTime?          @map("invite_expiry")
  invitedBy            Int?               @map("invited_by")
  createdAt            DateTime           @default(now()) @map("created_at")
  profileImage         String?            @map("profile_image")
  aiEnabled            Boolean            @default(false) @map("ai_enabled")
  aiProvider           String?            @map("ai_provider")
  aiApiKey             String?            @map("ai_api_key")
  dateFormat           String             @default("MM/DD/YYYY") @map("date_format")
  emailNotifications   Boolean            @default(true) @map("email_notifications")
  language             String             @default("en")
  projectNotifications Boolean            @default(true) @map("project_notifications")
  taskNotifications    Boolean            @default(true) @map("task_notifications")
  timezone             String             @default("UTC")
  twoFactorEnabled     Boolean            @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?            @map("two_factor_secret")
  weeklyDigest         Boolean            @default(false) @map("weekly_digest")
  activityLogs         ActivityLog[]
  apiKeys              ApiKey[]
  errorLogs            ErrorLog[]         @relation("ErrorReporter")
  integrations         Integration[]
  loginSessions        LoginSession[]
  uploadedModels       Model[]            @relation("ModelUploader")
  notifications        Notification[]
  progressLogs         ProgressLog[]      @relation("ProgressUpdater")
  projectUsers         ProjectUser[]
  createdProjects      Project[]          @relation("ProjectCreator")
  teamLeadProjects     Project[]          @relation("TeamLeadProjects")
  pushSubscriptions    PushSubscription[]
  roleRequests         RoleRequest[]
  siteViewLogs         SiteViewLog[]
  taskComments         TaskComment[]
  assignedTasks        Task[]
  teamMemberships      TeamMembership[]

  @@map("users")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String
  title     String
  body      String
  url       String?
  isRead    Boolean  @default(false) @map("is_read")
  isShown   Boolean  @default(false) @map("is_shown")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isShown])
  @@map("notifications")
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?  @map("user_agent")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model LoginSession {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  deviceName String   @map("device_name")
  deviceType String   @map("device_type")
  browser    String?
  ipAddress  String?  @map("ip_address")
  location   String?
  isActive   Boolean  @default(true) @map("is_active")
  lastActive DateTime @default(now()) @map("last_active")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("login_sessions")
}

model Project {
  id                  Int                 @id @default(autoincrement())
  name                String
  description         String?
  startDate           DateTime?           @map("start_date")
  endDate             DateTime?           @map("end_date")
  createdById         Int?                @map("created_by")
  createdAt           DateTime            @default(now()) @map("created_at")
  teamId              Int?                @map("team_id")
  teamLeaderId        Int?                @map("team_leader_id")
  speckleUrl          String?             @map("speckle_url")
  image               String?             @map("project_image")
  status              String              @default("active") @map("project_status")
  latitude            Float?
  location            String?
  longitude           Float?
  aiEnabled           Boolean             @default(false) @map("ai_enabled")
  openaiApiKey        String?             @map("openai_api_key")
  budget              Float?              @default(0)
  autoBackupEnabled   Boolean             @default(true) @map("auto_backup_enabled")
  autoBackupFrequency Int                 @default(24) @map("auto_backup_frequency")
  lastAutoBackup      DateTime?           @map("last_auto_backup")
  currency            String              @default("USD")
  city                String?
  state               String?
  country             String?
  postalCode          String?             @map("postal_code")
  stakeholders        Json?
  activityLogs        ActivityLog[]
  dailyLogs           DailyLog[]
  dailySiteCosts      DailySiteCost[]
  dailySiteProgress   DailySiteProgress[]
  errorLogs           ErrorLog[]
  models              Model[]
  projectBackups      ProjectBackup[]
  projectFiles        ProjectFile[]
  projectUsers        ProjectUser[]
  createdBy           User?               @relation("ProjectCreator", fields: [createdById], references: [id])
  team                Team?               @relation(fields: [teamId], references: [id])
  teamLeader          User?               @relation("TeamLeadProjects", fields: [teamLeaderId], references: [id])
  resources           Resource[]
  safetyIncidents     SafetyIncident[]
  scheduleHealth      ScheduleHealth[]
  siteCameras         SiteCamera[]
  siteCaptures        SiteCapture[]
  siteViewLogs        SiteViewLog[]
  tasks               Task[]
  toolboxTalks        ToolboxTalk[]

  @@map("projects")
}

model ProjectUser {
  id        Int     @id @default(autoincrement())
  userId    Int     @map("user_id")
  projectId Int     @map("project_id")
  role      String  @default("member")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("project_users")
}

model Model {
  id         Int       @id @default(autoincrement())
  projectId  Int       @map("project_id")
  name       String?
  source     String    @default("speckle")
  sourceUrl  String?   @map("source_url")
  sourceId   String?   @map("source_id")
  filePath   String?   @map("file_path")
  fileSize   Int?      @map("file_size")
  format     String?
  version    Int       @default(1)
  metadata   Json?
  uploadedBy Int?      @map("uploaded_by")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  elements   Element[]
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User?     @relation("ModelUploader", fields: [uploadedBy], references: [id])

  @@map("models")
}

model Element {
  id            Int               @id @default(autoincrement())
  modelId       Int               @map("model_id")
  guid          String?           @unique
  category      String?
  family        String?
  typeName      String?           @map("type_name")
  level         String?
  geometryRef   String?           @map("geometry_ref")
  parameters    Json?
  createdAt     DateTime          @default(now()) @map("created_at")
  resource      String?
  properties    ElementProperty[]
  elementStatus ElementStatus[]
  taskLinks     ElementTaskLink[]
  model         Model             @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@map("elements")
}

model ElementProperty {
  id        Int     @id @default(autoincrement())
  elementId Int     @map("element_id")
  key       String
  value     String
  element   Element @relation(fields: [elementId], references: [id], onDelete: Cascade)

  @@map("element_properties")
}

model Task {
  id                  Int                  @id @default(autoincrement())
  projectId           Int                  @map("project_id")
  parentId            Int?                 @map("parent_id")
  name                String
  description         String?
  startDate           DateTime?            @map("start_date")
  endDate             DateTime?            @map("end_date")
  actualStartDate     DateTime?            @map("actual_start_date")
  actualEndDate       DateTime?            @map("actual_end_date")
  durationDays        Int?                 @map("duration_days")
  progress            Float                @default(0.0)
  color               String?
  resource            String?
  createdAt           DateTime             @default(now()) @map("created_at")
  teamId              Int?                 @map("team_id")
  assigneeId          Int?                 @map("assignee_id")
  status              String               @default("todo")
  priority            String?
  predecessors        Dependency[]         @relation("PredecessorTask")
  successors          Dependency[]         @relation("SuccessorTask")
  elementStatus       ElementStatus[]
  elementLinks        ElementTaskLink[]
  progressLogs        ProgressLog[]
  resourceAssignments ResourceAssignment[]
  comments            TaskComment[]
  assignee            User?                @relation(fields: [assigneeId], references: [id])
  parent              Task?                @relation("TaskHierarchy", fields: [parentId], references: [id])
  children            Task[]               @relation("TaskHierarchy")
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team                Team?                @relation(fields: [teamId], references: [id])

  @@map("tasks")
}

model TaskComment {
  id          Int      @id @default(autoincrement())
  taskId      Int      @map("task_id")
  userId      Int      @map("user_id")
  comment     String
  attachments String?
  createdAt   DateTime @default(now()) @map("created_at")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

model Dependency {
  id            Int    @id @default(autoincrement())
  predecessorId Int    @map("predecessor_id")
  successorId   Int    @map("successor_id")
  type          String @default("FS")
  predecessor   Task   @relation("PredecessorTask", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor     Task   @relation("SuccessorTask", fields: [successorId], references: [id], onDelete: Cascade)

  @@map("dependencies")
}

model ElementTaskLink {
  id        Int       @id @default(autoincrement())
  elementId Int       @map("element_id")
  taskId    Int       @map("task_id")
  linkType  String    @default("construction") @map("link_type")
  status    String    @default("planned")
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")
  element   Element   @relation(fields: [elementId], references: [id], onDelete: Cascade)
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("element_task_links")
}

model ProgressLog {
  id              Int      @id @default(autoincrement())
  taskId          Int      @map("task_id")
  reportDate      DateTime @map("report_date")
  percentComplete Float?   @map("percent_complete")
  updatedBy       Int?     @map("updated_by")
  note            String?
  createdAt       DateTime @default(now()) @map("created_at")
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  updater         User?    @relation("ProgressUpdater", fields: [updatedBy], references: [id])

  @@map("progress_logs")
}

model ElementStatus {
  id           Int       @id @default(autoincrement())
  elementId    Int       @map("element_id")
  taskId       Int?      @map("task_id")
  actualStart  DateTime? @map("actual_start")
  actualFinish DateTime? @map("actual_finish")
  progress     Float     @default(0.0)
  lastUpdated  DateTime  @default(now()) @map("last_updated")
  element      Element   @relation(fields: [elementId], references: [id], onDelete: Cascade)
  task         Task?     @relation(fields: [taskId], references: [id])

  @@map("element_status")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  projectId Int      @map("project_id")
  action    String
  details   Json?
  timestamp DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model ErrorLog {
  id         Int      @id @default(autoincrement())
  timestamp  DateTime @default(now())
  level      String   @default("error")
  message    String
  stackTrace String?  @map("stack_trace")
  context    Json?
  userId     Int?     @map("user_id")
  projectId  Int?     @map("project_id")
  project    Project? @relation(fields: [projectId], references: [id])
  user       User?    @relation("ErrorReporter", fields: [userId], references: [id])

  @@map("error_logs")
}

model Team {
  id           Int              @id @default(autoincrement())
  name         String           @unique
  code         String?          @unique
  createdAt    DateTime         @default(now()) @map("created_at")
  projects     Project[]
  roleRequests RoleRequest[]
  tasks        Task[]
  members      TeamMembership[]

  @@map("teams")
}

model TeamMembership {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  teamId    Int      @map("team_id")
  projectId Int?     @map("project_id")
  role      String   @default("member")
  seniority String?
  createdAt DateTime @default(now()) @map("created_at")
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_memberships")
}

model RoleRequest {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  role      String
  teamId    Int?      @map("team_id")
  status    String    @default("pending")
  createdAt DateTime  @default(now()) @map("created_at")
  decidedAt DateTime? @map("decided_at")
  team      Team?     @relation(fields: [teamId], references: [id])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("role_requests")
}

model Resource {
  id          Int                  @id @default(autoincrement())
  projectId   Int                  @map("project_id")
  name        String
  type        String
  unit        String?
  hourlyRate  Float?               @map("hourly_rate")
  dailyRate   Float?               @map("daily_rate")
  capacity    Int?
  description String?
  createdAt   DateTime             @default(now()) @map("created_at")
  assignments ResourceAssignment[]
  costs       ResourceCost[]
  project     Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("resources")
}

model ResourceAssignment {
  id          Int       @id @default(autoincrement())
  resourceId  Int       @map("resource_id")
  taskId      Int       @map("task_id")
  quantity    Float     @default(1)
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  hoursPerDay Float?    @map("hours_per_day")
  status      String    @default("planned")
  createdAt   DateTime  @default(now()) @map("created_at")
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("resource_assignments")
}

model ResourceCost {
  id         Int      @id @default(autoincrement())
  resourceId Int      @map("resource_id")
  date       DateTime
  hours      Float?
  quantity   Float?
  unitCost   Float    @map("unit_cost")
  totalCost  Float    @map("total_cost")
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@map("resource_costs")
}

model SiteCamera {
  id          Int           @id @default(autoincrement())
  projectId   Int           @map("project_id")
  name        String
  cameraType  String        @default("360") @map("camera_type")
  brand       String?
  model       String?
  streamUrl   String?       @map("stream_url")
  snapshotUrl String?       @map("snapshot_url")
  apiKey      String?       @map("api_key")
  apiSecret   String?       @map("api_secret")
  location    String?
  latitude    Float?
  longitude   Float?
  altitude    Float?
  isActive    Boolean       @default(true) @map("is_active")
  isLive      Boolean       @default(false) @map("is_live")
  lastPingAt  DateTime?     @map("last_ping_at")
  settings    Json?
  createdAt   DateTime      @default(now()) @map("created_at")
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  captures    SiteCapture[]

  @@index([projectId])
  @@map("site_cameras")
}

model SiteCapture {
  id           Int         @id @default(autoincrement())
  projectId    Int         @map("project_id")
  cameraId     Int?        @map("camera_id")
  captureType  String      @map("capture_type")
  url          String
  thumbnailUrl String?     @map("thumbnail_url")
  fileSize     Int?        @map("file_size")
  duration     Int?
  resolution   String?
  capturedAt   DateTime    @map("captured_at")
  weather      String?
  temperature  Float?
  notes        String?
  metadata     Json?
  isProcessed  Boolean     @default(false) @map("is_processed")
  createdAt    DateTime    @default(now()) @map("created_at")
  camera       SiteCamera? @relation(fields: [cameraId], references: [id])
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([capturedAt])
  @@index([projectId])
  @@map("site_captures")
}

model DailySiteCost {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  date        DateTime
  category    String
  description String?
  quantity    Float?
  unit        String?
  unitCost    Float?   @map("unit_cost")
  totalCost   Float    @map("total_cost")
  currency    String   @default("INR")
  vendor      String?
  invoiceRef  String?  @map("invoice_ref")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, date])
  @@map("daily_site_costs")
}

model DailySiteProgress {
  id              Int      @id @default(autoincrement())
  projectId       Int      @map("project_id")
  date            DateTime
  workDescription String   @map("work_description")
  teamName        String?  @map("team_name")
  workersCount    Int?     @map("workers_count")
  hoursWorked     Float?   @map("hours_worked")
  progressPercent Float?   @map("progress_percent")
  weather         String?
  issues          String?
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, date])
  @@map("daily_site_progress")
}

model SiteViewLog {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  userId    Int      @map("user_id")
  viewType  String   @map("view_type")
  captureId Int?     @map("capture_id")
  viewedAt  DateTime @default(now()) @map("viewed_at")
  duration  Int?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@map("site_view_logs")
}

model ApiKey {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  name        String
  key         String    @unique
  keyPrefix   String    @map("key_prefix")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  permissions Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model Integration {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  type       String
  name       String
  config     Json
  isActive   Boolean   @default(true) @map("is_active")
  lastSyncAt DateTime? @map("last_sync_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@map("integrations")
}

model ScheduleHealth {
  id               Int      @id @default(autoincrement())
  projectId        Int      @map("project_id")
  date             DateTime @default(now())
  overallScore     Int      @default(0) @map("overall_score")
  scheduleScore    Int      @default(0) @map("schedule_score")
  costScore        Int      @default(0) @map("cost_score")
  resourceScore    Int      @default(0) @map("resource_score")
  spi              Float    @default(0)
  cpi              Float    @default(0)
  scheduleVariance Float    @default(0) @map("schedule_variance")
  costVariance     Float    @default(0) @map("cost_variance")
  bac              Float    @default(0)
  pv               Float    @default(0)
  ev               Float    @default(0)
  ac               Float    @default(0)
  eac              Float    @default(0)
  etc              Float    @default(0)
  vac              Float    @default(0)
  tcpi             Float    @default(0)
  createdAt        DateTime @default(now()) @map("created_at")
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@map("schedule_health")
}

model DailyLog {
  id              Int      @id @default(autoincrement())
  projectId       Int      @map("project_id")
  date            DateTime
  weather         String?
  temperatureLow  Float?   @map("temperature_low")
  temperatureHigh Float?   @map("temperature_high")
  crewCount       Int?     @map("crew_count")
  totalHours      Float?   @map("total_hours")
  activities      String?  @db.Text
  deliveries      Json?    @db.Json
  equipment       String?  @db.Text
  visitors        Json?    @db.Json
  issues          String?  @db.Text
  delays          String?  @db.Text
  notes           String?  @db.Text
  createdBy       Int      @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([projectId])
  @@index([date])
  @@map("daily_logs")
}

model SafetyIncident {
  id               Int       @id @default(autoincrement())
  projectId        Int       @map("project_id")
  date             DateTime
  type             String
  severity         String
  location         String?
  description      String
  injuredPerson    String?   @map("injured_person")
  witnessNames     String?   @map("witness_names")
  rootCause        String?   @map("root_cause")
  correctiveAction String?   @map("corrective_action")
  status           String    @default("open")
  reportedBy       Int       @map("reported_by")
  closedAt         DateTime? @map("closed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@index([status])
  @@map("safety_incidents")
}

model ToolboxTalk {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  date          DateTime
  topic         String
  description   String?
  conductedBy   String   @map("conducted_by")
  attendees     String?
  attendeeCount Int      @default(0) @map("attendee_count")
  duration      Int?
  notes         String?
  createdBy     Int      @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@map("toolbox_talks")
}

model ProjectFile {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String
  fileName    String   @map("file_name")
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  filePath    String   @map("file_path")
  category    String?
  description String?
  uploadedBy  Int      @map("uploaded_by")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
  @@map("project_files")
}

model ProjectBackup {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String
  description String?
  filePath    String   @map("file_path")
  fileSize    Int      @map("file_size")
  createdBy   Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  isAutomatic Boolean  @default(false) @map("is_automatic")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_backups")
}
